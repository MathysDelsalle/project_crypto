<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AlertCheckService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">collector</a> &gt; <a href="index.source.html" class="el_package">collector.service</a> &gt; <span class="el_source">AlertCheckService.java</span></div><h1>AlertCheckService.java</h1><pre class="source lang-java linenums">package collector.service;

import collector.model.PriceAlert;
import collector.repository.PriceAlertRepository;
import collector.repository.UserRepository;
import jakarta.transaction.Transactional;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;

import java.time.Instant;
import java.util.List;

@Service
<span class="fc" id="L16">@RequiredArgsConstructor</span>
<span class="fc" id="L17">@Slf4j</span>
public class AlertCheckService {

    private final PriceAlertRepository alertRepository;
    private final UserRepository userRepository;
    private final MailService mailService;

    @Value(&quot;${app.mail.frontendUrl:http://localhost:3000}&quot;)
    private String frontendUrl;

    @Transactional
    public void checkAlerts() {
<span class="fc" id="L29">        List&lt;PriceAlert&gt; alerts = alertRepository.findByActiveTrue();</span>
<span class="fc" id="L30">        Instant now = Instant.now();</span>

<span class="fc bfc" id="L32" title="All 2 branches covered.">        for (PriceAlert alert : alerts) {</span>

<span class="fc" id="L34">            var asset = alert.getAsset();</span>
<span class="fc bfc" id="L35" title="All 2 branches covered.">            Double price = asset != null ? asset.getCurrentPrice() : null;</span>
<span class="fc bfc" id="L36" title="All 2 branches covered.">            if (price == null) continue;</span>

            // üîë r√©cup√©rer l'email utilisateur
<span class="fc" id="L39">            String email = userRepository.findById(alert.getUserId())</span>
<span class="fc" id="L40">                    .map(u -&gt; u.getEmail())</span>
<span class="fc" id="L41">                    .orElse(null);</span>

<span class="fc bfc" id="L43" title="All 2 branches covered.">            if (email == null) {</span>
<span class="fc" id="L44">                log.warn(&quot;‚ö†Ô∏è Aucun email pour userId={}&quot;, alert.getUserId());</span>
<span class="fc" id="L45">                continue;</span>
            }

<span class="fc" id="L48">            String assetName = asset.getExternalId();</span>
<span class="fc" id="L49">            String link = frontendUrl + &quot;/alerts&quot;;</span>

            // üî∫ ALERTE HIGH
<span class="pc bpc" id="L52" title="1 of 2 branches missed.">            if (alert.getThresholdHigh() != null</span>
<span class="fc bfc" id="L53" title="All 2 branches covered.">                    &amp;&amp; alert.getLastTriggeredHighAt() == null</span>
<span class="fc bfc" id="L54" title="All 2 branches covered.">                    &amp;&amp; price &gt;= alert.getThresholdHigh()) {</span>

<span class="fc" id="L56">                String html = buildAlertHtml(</span>
<span class="fc" id="L57">                        assetName, price, alert.getThresholdHigh(),</span>
                        &quot;AU-DESSUS&quot;, link
                );

<span class="fc" id="L61">                mailService.sendHtml(</span>
                        email,
                        &quot;üö® Alerte HIGH &quot; + assetName,
                        html
                );

<span class="fc" id="L67">                alert.setLastTriggeredHighAt(now);</span>

<span class="fc" id="L69">                log.warn(&quot;üìß EMAIL HIGH envoy√© ‚Üí {} ({})&quot;, email, assetName);</span>
            }

            // üîª ALERTE LOW
<span class="pc bpc" id="L73" title="1 of 2 branches missed.">            if (alert.getThresholdLow() != null</span>
<span class="fc bfc" id="L74" title="All 2 branches covered.">                    &amp;&amp; alert.getLastTriggeredLowAt() == null</span>
<span class="fc bfc" id="L75" title="All 2 branches covered.">                    &amp;&amp; price &lt;= alert.getThresholdLow()) {</span>

<span class="fc" id="L77">                String html = buildAlertHtml(</span>
<span class="fc" id="L78">                        assetName, price, alert.getThresholdLow(),</span>
                        &quot;EN-DESSOUS&quot;, link
                );

<span class="fc" id="L82">                mailService.sendHtml(</span>
                        email,
                        &quot;üö® Alerte LOW &quot; + assetName,
                        html
                );

<span class="fc" id="L88">                alert.setLastTriggeredLowAt(now);</span>

<span class="fc" id="L90">                log.warn(&quot;üìß EMAIL LOW envoy√© ‚Üí {} ({})&quot;, email, assetName);</span>
            }
<span class="fc" id="L92">        }</span>
<span class="fc" id="L93">    }</span>

    private String buildAlertHtml(
            String asset, double price,
            double target, String direction,
            String link
    ) {
<span class="fc" id="L100">        return &quot;&quot;&quot;</span>
            &lt;div style=&quot;font-family:Arial,sans-serif;line-height:1.6&quot;&gt;
              &lt;h2&gt;üö® Alerte crypto d√©clench√©e&lt;/h2&gt;
              &lt;p&gt;&lt;b&gt;Actif :&lt;/b&gt; %s&lt;/p&gt;
              &lt;p&gt;&lt;b&gt;Prix actuel :&lt;/b&gt; %.6f&lt;/p&gt;
              &lt;p&gt;&lt;b&gt;Seuil :&lt;/b&gt; %.6f (%s)&lt;/p&gt;
              &lt;p&gt;
                &lt;a href=&quot;%s&quot;
                   style=&quot;display:inline-block;padding:10px 14px;
                          background:#111;color:#fff;
                          text-decoration:none;border-radius:6px&quot;&gt;
                  Ouvrir l'application
                &lt;/a&gt;
              &lt;/p&gt;
              &lt;hr/&gt;
              &lt;p style=&quot;color:#666;font-size:12px&quot;&gt;
                Email automatique ‚Äî ne pas r√©pondre
              &lt;/p&gt;
            &lt;/div&gt;
<span class="fc" id="L119">            &quot;&quot;&quot;.formatted(asset, price, target, direction, link);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>